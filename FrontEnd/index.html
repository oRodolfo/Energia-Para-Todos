<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energia para Todos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <link rel="stylesheet" href="assets/css/styles.css">
  <style>
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Card de Dashboard Logado */
    .card-dashboard-logado {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: linear-gradient(135deg, #ff9500, #ffd34d);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 0 30px rgba(255, 149, 0, 0.4);
      max-width: 300px;
      animation: slideInRight 0.5s ease-out;
    }

    .card-dashboard__titulo {
      color: #211c29;
      font-weight: 800;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .card-dashboard__nome {
      color: #211c29;
      font-size: 0.95rem;
      margin-bottom: 14px;
    }

    .card-dashboard__botao {
      width: 100%;
      padding: 12px 16px;
      background: #211c29;
      color: #ff9500;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
    }

    .card-dashboard__botao:hover {
      transform: scale(1.05);
    }

    .card-dashboard__botao:active {
      transform: scale(1);
    }

    /* Responsivo */
    @media (max-width: 480px) {
      .card-dashboard-logado {
        top: 10px;
        right: 10px;
        max-width: calc(100% - 20px);
        padding: 16px;
      }

      .card-dashboard__titulo {
        font-size: 1rem;
      }

      .card-dashboard__nome {
        font-size: 0.9rem;
      }

      .card-dashboard__botao {
        padding: 10px 14px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <header class="header" role="banner">
    <div class="container">
      <a href="#inicio" class="logo" aria-label="Energia para Todos Home">‚ö° Energia para Todos</a>
      <nav class="nav" role="navigation" aria-label="Menu Principal">
        <ul class="nav__list">
          <li><a href="#inicio" class="nav__link">In√≠cio</a></li>
          <li><a href="#impacto" class="nav__link">Impacto</a></li>
          <li><a href="#sobre" class="nav__link">Sobre</a></li>
          <li><a href="#como-funciona" class="nav__link">Como Funciona</a></li>
          <li><a href="#duvida" class="nav__link">D√∫vidas frequentes</a></li>
          <li><a href="login.html" class="nav__link login_btn" id="nav-login-btn">Login</a></li>
        </ul>
      </nav>
      <button id="mobile_btn" aria-label="Abrir menu mobile" aria-controls="mobile_menu" aria-expanded="false">
        <i data-feather="menu"></i>
      </button>
    </div>
    <nav id="mobile_menu" class="mobile_menu" aria-label="Menu Mobile" tabindex="-1">
      <ul id="mobile_nav_list">
        <li class="nav_item"><a href="#inicio">In√≠cio</a></li>
        <li class="nav_item"><a href="#impacto">Impacto</a></li>
        <li class="nav_item"><a href="#sobre">Sobre</a></li>
        <li class="nav_item"><a href="#como-funciona">Como Funciona</a></li>
        <li class="nav_item"><a href="#duvida">D√∫vidas frequentes</a></li>
      </ul>
      <a href="login.html" class="btn btn--neon" id="mobile-login-btn" style="margin-top:1rem;">Login</a>
    </nav>
  </header>

  <main>
    <!-- Card de Bem-vindo para Usu√°rio Logado -->
    <div id="card-dashboard-logado" class="card-dashboard-logado" style="display: none;">
      <div class="card-dashboard__titulo">üëã Bem-vindo de volta!</div>
      <div id="nome-usuario-card" class="card-dashboard__nome"></div>
      <button id="btn-acessar-dashboard" class="card-dashboard__botao">
        Acessar seu Dashboard
      </button>
    </div>

    <section class="hero" id="inicio">
      <div class="container hero__content">
        <h1 class="hero__title">
          Transforme Energia em <span class="hero__title-line--neon">Esperan√ßa</span>
        </h1>
        <p class="hero__subtitle">Conectamos quem tem excedente de energia solar com comunidades carentes, criando uma rede solid√°ria que ilumina vidas.</p>
        <div class="hero__actions">
          <a href="login.html" class="btn btn--neon">Doe Agora</a>
          <a href="ods.html" class="btn btn--outline-neon">ODS 7 - Saiba Mais</a>
        </div>
      </div>
    </section>

    <section class="impact" id="impacto">
      <div class="container">
        <span class="section__label">Nosso Impacto</span>
        <h2 class="section__title">Energia transformando vidas</h2>
        <div class="impact__stats">
          <div class="impact__stat">
            <h4 id="total-kwh-distribuido">
              <span class="loader-text">Carregando...</span>
            </h4>
            <p>Distribu√≠dos</p>
          </div>
          <div class="impact__stat">
            <h4 id="familias-atendidas">
              <span class="loader-text">Carregando...</span>
            </h4>
            <p>Fam√≠lias atendidas</p>
          </div>
        </div>
      </div>
    </section>

    <section class="mission" id="sobre">
      <div class="container">
        <span class="section__label">Nossa Miss√£o</span>
        <h2 class="section__title">Democratiza√ß√£o do acesso √† <span class="highlight">energia limpa</span></h2>
        <p class="section__description">Promovemos inclus√£o energ√©tica conectando doadores a fam√≠lias em vulnerabilidade social.</p>
        <div class="mission__features">
          <div class="feature">
            <i data-feather="sun" class="feature__icon"></i>
            <h4>Sustentabilidade</h4>
            <p>Reduzindo a pegada de carbono e promovendo um futuro mais verde.</p>
          </div>
          <div class="feature">
            <i data-feather="heart" class="feature__icon"></i>
            <h4>Solidariedade</h4>
            <p>Conectando pessoas e comunidades para gerar impacto positivo.</p>
          </div>
          <div class="feature">
            <i data-feather="cpu" class="feature__icon"></i>
            <h4>Inova√ß√£o</h4>
            <p>Usando tecnologia de ponta para otimizar a distribui√ß√£o de energia.</p>
          </div>
        </div>
      </div>
    </section>

    <section class="gallery" id="galeria">
      <div class="container">
        <span class="section__label">Nossa Realidade</span>
        <h2 class="section__title">Iluminando Comunidades</h2>
        <div class="gallery__grid">
          <div class="gallery__item" tabindex="0" aria-label="Instalando esperan√ßa ">
            <img src="/assets/images/imagem2.jpg" alt="Crian√ßas sorrindo em comunidade">
            <div class="gallery__overlay">Instalando esperan√ßa</div>
          </div>
          <div class="gallery__item" tabindex="0" aria-label="Energia que transforma lares">
            <img src="/assets/images/imagem3.jpg" alt="Painel solar sendo instalado em telhado">
            <div class="gallery__overlay">Energia que transforma lares</div>
          </div>
          <div class="gallery__item" tabindex="0" aria-label="O poder da tecnologia dentro da Sustentabilidade">
            <img src="/assets/images/i.a img.png" alt="M√£os segurando uma l√¢mpada acesa">
            <div class="gallery__overlay">O poder da tecnologia dentro da Sustentabilidade</div>
          </div>
        </div>
      </div>
    </section>

    <section class="how-it-works" id="como-funciona">
      <div class="container">
        <span class="section__label">Como Funciona</span>
        <h2 class="section__title">Energia que gera <span class="highlight">impacto real</span></h2>
        <div class="steps">
          <div class="step">
            <i data-feather="user-plus" class="step__icon"></i>
            <h3>1. Cadastro do Doador</h3>
            <p>Empresas e pessoas com sistemas de energia renov√°vel se cadastram em nossa plataforma de forma simples e r√°pida.</p>
          </div>
          <div class="step">
            <i data-feather="bar-chart-2" class="step__icon"></i>
            <h3>2. An√°lise e C√°lculo</h3>
            <p>Nossa IA analisa os dados de gera√ß√£o e calcula o excedente de energia que pode ser doado sem custos para o gerador.</p>
          </div>
          <div class="step">
            <i data-feather="send" class="step__icon"></i>
            <h3>3. Distribui√ß√£o Inteligente</h3>
            <p>O excedente √© convertido em cr√©ditos e distribu√≠do para fam√≠lias cadastradas, reduzindo suas contas de luz.</p>
          </div>
        </div>
      </div>
    </section>

    <section class="contact" id="duvida">
      <div class="container">
        <span class="section__label">D√∫vidas frequentes</span>
        <h2 class="section__title">Fa√ßa parte da mudan√ßa</h2>
        <p class="section__description">
          Esclare√ßa suas d√∫vidas e entre para essa iniciativa que transforma vidas.  
          Veja abaixo as perguntas mais comuns e, se preferir, fale com a gente pelo formul√°rio.
        </p>

        <!-- FAQ  -->
        <div class="faq" style="max-width: 900px; margin: 3rem auto;">
          <div class="faq__item">
            <button class="faq__question" aria-expanded="false">
              <span>‚ùì Como funciona a doa√ß√£o de energia?</span>
              <i data-feather="chevron-down"></i>
            </button>
            <div class="faq__answer">
              <p>A energia excedente do seu painel solar √© convertida em cr√©ditos e repassada automaticamente √†s fam√≠lias cadastradas.</p>
            </div>
          </div>

          <div class="faq__item">
            <button class="faq__question" aria-expanded="false">
              <span>üí∞ Existem custos para o doador?</span>
              <i data-feather="chevron-down"></i>
            </button>
            <div class="faq__answer">
              <p>N√£o! A opera√ß√£o √© totalmente gratuita ‚Äì voc√™ contribui apenas com o excedente que j√° teria naturalmente.</p>
            </div>
          </div>

          <div class="faq__item">
            <button class="faq__question" aria-expanded="false">
              <span>üë®‚Äçüë©‚Äçüëß Quem recebe a energia?</span>
              <i data-feather="chevron-down"></i>
            </button>
            <div class="faq__answer">
              <p>Fam√≠lias em situa√ß√£o de vulnerabilidade e comunidades cadastradas conforme crit√©rios sociais e energ√©ticos.</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer role="contentinfo">
    <div class="container">
      <p>¬© 2025 Energia Solid√°ria - Todos os direitos reservados</p>
    </div>
  </footer>

  <!-- SCRIPT PARA DETEC√á√ÉO DE USU√ÅRIO LOGADO -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await verificarUsuarioLogado();
      await carregarEstatisticasReais();
    });

    async function carregarEstatisticasReais() {
      try {
        console.log('üîÑ Buscando estat√≠sticas...');
        
        const response = await fetch('/api/estatisticas-gerais', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });

        if (response.ok) {
            const resultado = await response.json();
            console.log('üìä Resposta da API:', resultado);
          
            if (resultado.sucesso && resultado.dados) {
                const { total_kwh, familias_atendidas } = resultado.dados;
            
                // Formata kWh
                let kwhFormatado;
                if (total_kwh >= 1000000) {
                    kwhFormatado = (total_kwh / 1000000).toFixed(1) + 'M kWh';
                } else if (total_kwh >= 1000) {
                    kwhFormatado = (total_kwh / 1000).toFixed(1) + 'K kWh';
                } else {
                    kwhFormatado = total_kwh.toFixed(0) + ' kWh';
                }
            
                // Atualiza DOM
                const elementoKwh = document.getElementById('total-kwh-distribuido');
                const elementoFamilias = document.getElementById('familias-atendidas');
            
                if (elementoKwh) {
                    elementoKwh.textContent = kwhFormatado;
                    console.log('‚úÖ kWh atualizado:', kwhFormatado);
                }
            
                if (elementoFamilias) {
                    elementoFamilias.textContent = familias_atendidas;
                    console.log('‚úÖ Fam√≠lias atualizadas:', familias_atendidas);
                }
            } else {
                console.error('‚ùå Dados inv√°lidos:', resultado);
                exibirEstatisticasPadrao();
            }
        } else {
            console.error('‚ùå Erro HTTP:', response.status);
            exibirEstatisticasPadrao();
        }
      } catch (error) {
        console.error('‚ùå Erro ao buscar estat√≠sticas:', error);
        exibirEstatisticasPadrao();
      }
  }

function exibirEstatisticasPadrao() {
    const elementoKwh = document.getElementById('total-kwh-distribuido');
    const elementoFamilias = document.getElementById('familias-atendidas');
    
    if (elementoKwh) elementoKwh.textContent = '0 kWh';
    if (elementoFamilias) elementoFamilias.textContent = '0';
}

    // ‚úÖ FUN√á√ÉO PRINCIPAL: Verificar se usu√°rio est√° logado e mostrar card
    async function verificarUsuarioLogado() {
      try {
        // Tenta m√∫ltiplos endpoints para garantir que funcione
        let data = null;
        
        // Primeira tentativa: /api/meu-perfil
        try {
          const resp = await fetch('/api/meu-perfil', {
            method: 'GET',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Cache-Control': 'no-cache'
            }
          });
          
          if (resp.ok) {
            data = await resp.json();
          }
        } catch (e) {
          console.log('Primeira tentativa falhou, tentando alternativa...');
        }

        // Segunda tentativa: verificar se h√° dados de sess√£o
        if (!data || !data.sucesso) {
          try {
            const resp2 = await fetch('/api/beneficiario/dados', {
              credentials: 'include'
            });
            if (resp2.ok) {
              const benefData = await resp2.json();
              if (benefData.sucesso) {
                data = {
                  sucesso: true,
                  usuario_id: benefData.dados?.usuario_id || true,
                  nome: benefData.dados?.nome || 'Usu√°rio',
                  tipo: 'BENEFICIARIO'
                };
              }
            }
          } catch (e) {
            // Ignora
          }
        }

        // Terceira tentativa: verificar doador
        if (!data || !data.sucesso) {
          try {
            const resp3 = await fetch('/api/doador/dados', {
              credentials: 'include'
            });
            if (resp3.ok) {
              const doadorData = await resp3.json();
              if (doadorData.sucesso) {
                data = {
                  sucesso: true,
                  usuario_id: doadorData.dados?.usuario_id || true,
                  nome: doadorData.dados?.nome || doadorData.dados?.razao_social || 'Usu√°rio',
                  tipo: 'DOADOR'
                };
              }
            }
          } catch (e) {
            // Ignora
          }
        }

        // Se conseguiu dados de alguma fonte
        if (data && data.sucesso && data.usuario_id) {
          console.log('‚úÖ Usu√°rio logado detectado:', data.nome, '-', data.tipo);
          
          // 1. ESCONDER BOT√ïES DE LOGIN (desktop e mobile)
          const btnLoginDesktop = document.getElementById('nav-login-btn');
          const btnLoginMobile = document.getElementById('mobile-login-btn');
          
          if (btnLoginDesktop) {
            btnLoginDesktop.style.display = 'none';
          }
          
          if (btnLoginMobile) {
            btnLoginMobile.style.display = 'none';
          }

          // 2. MOSTRAR CARD DE BOAS-VINDAS
          const cardDashboard = document.getElementById('card-dashboard-logado');
          const nomeUsuarioCard = document.getElementById('nome-usuario-card');
          const btnAcessarDashboard = document.getElementById('btn-acessar-dashboard');

          if (cardDashboard && nomeUsuarioCard && btnAcessarDashboard) {
            nomeUsuarioCard.textContent = `Ol√°, ${data.nome}!`;
            cardDashboard.style.display = 'block';

            // 3. CONFIGURAR CLIQUE DO BOT√ÉO PARA IR AO DASHBOARD CORRETO
            btnAcessarDashboard.onclick = () => {
              if (data.tipo === 'ADMINISTRADOR') {
                window.location.href = '/crud';
              } else if (data.tipo === 'BENEFICIARIO') {
                window.location.href = '/painel-beneficiario';
              } else if (data.tipo === 'DOADOR') {
                window.location.href = '/painel-doador';
              } else {
                window.location.href = '/';
              }
            };
          }
        } else {
          console.log('‚ÑπÔ∏è Usu√°rio n√£o logado - p√°gina inicial normal');
        }
      } catch (err) {
        console.log('‚ÑπÔ∏è Erro ao verificar usu√°rio:', err.message);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
    await carregarEstatisticasReais();
});

async function carregarEstatisticasReais() {
    try {
        console.log('üìä Buscando estat√≠sticas do banco...');
        
        const response = await fetch('/api/estatisticas-gerais', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });

        if (response.ok) {
            const resultado = await response.json();
            console.log('‚úÖ Estat√≠sticas recebidas:', resultado);
            
            if (resultado.sucesso && resultado.dados) {
                const { total_kwh, familias_atendidas } = resultado.dados;
                
                // Formata kWh para exibi√ß√£o
                let kwhFormatado;
                if (total_kwh >= 1000000) {
                    kwhFormatado = (total_kwh / 1000000).toFixed(1) + 'M kWh';
                } else if (total_kwh >= 1000) {
                    kwhFormatado = (total_kwh / 1000).toFixed(1) + 'K kWh';
                } else {
                    kwhFormatado = total_kwh.toFixed(0) + ' kWh';
                }
                
                // Atualiza elementos do DOM
                const elementoKwh = document.getElementById('total-kwh-distribuido');
                const elementoFamilias = document.getElementById('familias-atendidas');
                
                if (elementoKwh) {
                    elementoKwh.textContent = kwhFormatado;
                    console.log('‚úÖ kWh atualizado:', kwhFormatado);
                }
                
                if (elementoFamilias) {
                    elementoFamilias.textContent = familias_atendidas;
                    console.log('‚úÖ Fam√≠lias atualizadas:', familias_atendidas);
                }
            } else {
                console.error('‚ùå Dados inv√°lidos:', resultado);
                exibirEstatisticasPadrao();
            }
        } else {
            console.error('‚ùå Erro HTTP:', response.status);
            exibirEstatisticasPadrao();
        }
    } catch (error) {
        console.error('‚ùå Erro ao buscar estat√≠sticas:', error);
        exibirEstatisticasPadrao();
    }
}

function exibirEstatisticasPadrao() {
    const elementoKwh = document.getElementById('total-kwh-distribuido');
    const elementoFamilias = document.getElementById('familias-atendidas');
    
    if (elementoKwh) elementoKwh.textContent = '0 kWh';
    if (elementoFamilias) elementoFamilias.textContent = '0';
}
  </script>

  <script src="/assets/js/main.js"></script>
</body>
</html>